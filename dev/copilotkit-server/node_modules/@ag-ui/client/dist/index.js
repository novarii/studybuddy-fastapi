"use strict";var Xt=Object.create;var Q=Object.defineProperty,jt=Object.defineProperties,zt=Object.getOwnPropertyDescriptor,Kt=Object.getOwnPropertyDescriptors,Jt=Object.getOwnPropertyNames,et=Object.getOwnPropertySymbols,$t=Object.getPrototypeOf,mt=Object.prototype.hasOwnProperty,ht=Object.prototype.propertyIsEnumerable;var vt=(i,s,e)=>s in i?Q(i,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[s]=e,L=(i,s)=>{for(var e in s||(s={}))mt.call(s,e)&&vt(i,e,s[e]);if(et)for(var e of et(s))ht.call(s,e)&&vt(i,e,s[e]);return i},H=(i,s)=>jt(i,Kt(s));var yt=(i,s)=>{var e={};for(var n in i)mt.call(i,n)&&s.indexOf(n)<0&&(e[n]=i[n]);if(i!=null&&et)for(var n of et(i))s.indexOf(n)<0&&ht.call(i,n)&&(e[n]=i[n]);return e};var Vt=(i,s)=>{for(var e in s)Q(i,e,{get:s[e],enumerable:!0})},nt=(i,s,e,n)=>{if(s&&typeof s=="object"||typeof s=="function")for(let t of Jt(s))!mt.call(i,t)&&t!==e&&Q(i,t,{get:()=>s[t],enumerable:!(n=zt(s,t))||n.enumerable});return i},G=(i,s,e)=>(nt(i,s,"default"),e&&nt(e,s,"default")),st=(i,s,e)=>(e=i!=null?Xt($t(i)):{},nt(s||!i||!i.__esModule?Q(e,"default",{value:i,enumerable:!0}):e,i)),Wt=i=>nt(Q({},"__esModule",{value:!0}),i);var P={};Vt(P,{AbstractAgent:()=>Y,HttpAgent:()=>pt,compactEvents:()=>Bt,convertToLegacyEvents:()=>ut,defaultApplyEvents:()=>J,parseProtoStream:()=>lt,parseSSEStream:()=>it,randomUUID:()=>Yt,runHttpRequest:()=>rt,structuredClone_:()=>M,transformChunks:()=>j,transformHttpEventStream:()=>ct,verifyEvents:()=>$});module.exports=Wt(P);var x=require("@ag-ui/core"),K=require("rxjs/operators"),at=require("rxjs");var Mt=require("uuid");var M=i=>{if(typeof structuredClone=="function")return structuredClone(i);try{return JSON.parse(JSON.stringify(i))}catch(s){return L({},i)}};function Yt(){return(0,Mt.v4)()}var ft=require("fast-json-patch");async function _(i,s,e,n){let t=s,a=e,r;for(let o of i)try{let l=await n(o,M(t),M(a));if(l===void 0)continue;if(l.messages!==void 0&&(t=l.messages),l.state!==void 0&&(a=l.state),r=l.stopPropagation,r===!0)break}catch(l){process.env.NODE_ENV==="test"||process.env.JEST_WORKER_ID!==void 0||console.error("Subscriber error:",l);continue}return L(L(L({},JSON.stringify(t)!==JSON.stringify(s)?{messages:t}:{}),JSON.stringify(a)!==JSON.stringify(e)?{state:a}:{}),r!==void 0?{stopPropagation:r}:{})}var Ct=st(require("untruncate-json"));var J=(i,s,e,n)=>{let t=M(e.messages),a=M(i.state),r={},o=p=>{p.messages!==void 0&&(t=p.messages,r.messages=p.messages),p.state!==void 0&&(a=p.state,r.state=p.state)},l=()=>{let p=M(r);return r={},p.messages!==void 0||p.state!==void 0?(0,at.of)(p):at.EMPTY};return s.pipe((0,K.concatMap)(async p=>{var T,h,c,F,z;let S=await _(n,t,a,(E,g,d)=>{var m;return(m=E.onEvent)==null?void 0:m.call(E,{event:p,agent:e,input:i,messages:g,state:d})});if(o(S),S.stopPropagation===!0)return l();switch(p.type){case x.EventType.TEXT_MESSAGE_START:{let E=await _(n,t,a,(g,d,m)=>{var u;return(u=g.onTextMessageStartEvent)==null?void 0:u.call(g,{event:p,messages:d,state:m,agent:e,input:i})});if(o(E),E.stopPropagation!==!0){let{messageId:g,role:d="assistant"}=p,m={id:g,role:d,content:""};t.push(m),o({messages:t})}return l()}case x.EventType.TEXT_MESSAGE_CONTENT:{let{messageId:E,delta:g}=p,d=t.find(u=>u.id===E);if(!d)return console.warn(`TEXT_MESSAGE_CONTENT: No message found with ID '${E}'`),l();let m=await _(n,t,a,(u,y,C)=>{var N;return(N=u.onTextMessageContentEvent)==null?void 0:N.call(u,{event:p,messages:y,state:C,agent:e,input:i,textMessageBuffer:typeof d.content=="string"?d.content:""})});if(o(m),m.stopPropagation!==!0){let u=typeof d.content=="string"?d.content:"";d.content=`${u}${g}`,o({messages:t})}return l()}case x.EventType.TEXT_MESSAGE_END:{let{messageId:E}=p,g=t.find(m=>m.id===E);if(!g)return console.warn(`TEXT_MESSAGE_END: No message found with ID '${E}'`),l();let d=await _(n,t,a,(m,u,y)=>{var C;return(C=m.onTextMessageEndEvent)==null?void 0:C.call(m,{event:p,messages:u,state:y,agent:e,input:i,textMessageBuffer:typeof g.content=="string"?g.content:""})});return o(d),await Promise.all(n.map(m=>{var u;(u=m.onNewMessage)==null||u.call(m,{message:g,messages:t,state:a,agent:e,input:i})})),l()}case x.EventType.TOOL_CALL_START:{let E=await _(n,t,a,(g,d,m)=>{var u;return(u=g.onToolCallStartEvent)==null?void 0:u.call(g,{event:p,messages:d,state:m,agent:e,input:i})});if(o(E),E.stopPropagation!==!0){let{toolCallId:g,toolCallName:d,parentMessageId:m}=p,u;m&&t.length>0&&t[t.length-1].id===m?u=t[t.length-1]:(u={id:m||g,role:"assistant",toolCalls:[]},t.push(u)),(T=u.toolCalls)!=null||(u.toolCalls=[]),u.toolCalls.push({id:g,type:"function",function:{name:d,arguments:""}}),o({messages:t})}return l()}case x.EventType.TOOL_CALL_ARGS:{let{toolCallId:E,delta:g}=p,d=t.find(y=>{var C;return(C=y.toolCalls)==null?void 0:C.some(N=>N.id===E)});if(!d)return console.warn(`TOOL_CALL_ARGS: No message found containing tool call with ID '${E}'`),l();let m=d.toolCalls.find(y=>y.id===E);if(!m)return console.warn(`TOOL_CALL_ARGS: No tool call found with ID '${E}'`),l();let u=await _(n,t,a,(y,C,N)=>{var dt;let O=m.function.arguments,b=m.function.name,q={};try{q=(0,Ct.default)(O)}catch(Ee){}return(dt=y.onToolCallArgsEvent)==null?void 0:dt.call(y,{event:p,messages:C,state:N,agent:e,input:i,toolCallBuffer:O,toolCallName:b,partialToolCallArgs:q})});return o(u),u.stopPropagation!==!0&&(m.function.arguments+=g,o({messages:t})),l()}case x.EventType.TOOL_CALL_END:{let{toolCallId:E}=p,g=t.find(u=>{var y;return(y=u.toolCalls)==null?void 0:y.some(C=>C.id===E)});if(!g)return console.warn(`TOOL_CALL_END: No message found containing tool call with ID '${E}'`),l();let d=g.toolCalls.find(u=>u.id===E);if(!d)return console.warn(`TOOL_CALL_END: No tool call found with ID '${E}'`),l();let m=await _(n,t,a,(u,y,C)=>{var q;let N=d.function.arguments,O=d.function.name,b={};try{b=JSON.parse(N)}catch(dt){}return(q=u.onToolCallEndEvent)==null?void 0:q.call(u,{event:p,messages:y,state:C,agent:e,input:i,toolCallName:O,toolCallArgs:b})});return o(m),await Promise.all(n.map(u=>{var y;(y=u.onNewToolCall)==null||y.call(u,{toolCall:d,messages:t,state:a,agent:e,input:i})})),l()}case x.EventType.TOOL_CALL_RESULT:{let E=await _(n,t,a,(g,d,m)=>{var u;return(u=g.onToolCallResultEvent)==null?void 0:u.call(g,{event:p,messages:d,state:m,agent:e,input:i})});if(o(E),E.stopPropagation!==!0){let{messageId:g,toolCallId:d,content:m,role:u}=p,y={id:g,toolCallId:d,role:u||"tool",content:m};t.push(y),await Promise.all(n.map(C=>{var N;(N=C.onNewMessage)==null||N.call(C,{message:y,messages:t,state:a,agent:e,input:i})})),o({messages:t})}return l()}case x.EventType.STATE_SNAPSHOT:{let E=await _(n,t,a,(g,d,m)=>{var u;return(u=g.onStateSnapshotEvent)==null?void 0:u.call(g,{event:p,messages:d,state:m,agent:e,input:i})});if(o(E),E.stopPropagation!==!0){let{snapshot:g}=p;a=g,o({state:a})}return l()}case x.EventType.STATE_DELTA:{let E=await _(n,t,a,(g,d,m)=>{var u;return(u=g.onStateDeltaEvent)==null?void 0:u.call(g,{event:p,messages:d,state:m,agent:e,input:i})});if(o(E),E.stopPropagation!==!0){let{delta:g}=p;try{a=(0,ft.applyPatch)(a,g,!0,!1).newDocument,o({state:a})}catch(d){let m=d instanceof Error?d.message:String(d);console.warn(`Failed to apply state patch:
Current state: ${JSON.stringify(a,null,2)}
Patch operations: ${JSON.stringify(g,null,2)}
Error: ${m}`)}}return l()}case x.EventType.MESSAGES_SNAPSHOT:{let E=await _(n,t,a,(g,d,m)=>{var u;return(u=g.onMessagesSnapshotEvent)==null?void 0:u.call(g,{event:p,messages:d,state:m,agent:e,input:i})});if(o(E),E.stopPropagation!==!0){let{messages:g}=p;t=g,o({messages:t})}return l()}case x.EventType.ACTIVITY_SNAPSHOT:{let E=p,g=t.findIndex(C=>C.id===E.messageId),d=g>=0?t[g]:void 0,m=(d==null?void 0:d.role)==="activity"?d:void 0,u=(h=E.replace)!=null?h:!0,y=await _(n,t,a,(C,N,O)=>{var b;return(b=C.onActivitySnapshotEvent)==null?void 0:b.call(C,{event:E,messages:N,state:O,agent:e,input:i,activityMessage:m,existingMessage:d})});if(o(y),y.stopPropagation!==!0){let C={id:E.messageId,role:"activity",activityType:E.activityType,content:M(E.content)},N;g===-1?(t.push(C),N=C):m?u&&(t[g]=H(L({},m),{activityType:E.activityType,content:M(E.content)})):u&&(t[g]=C,N=C),o({messages:t}),N&&await Promise.all(n.map(O=>{var b;return(b=O.onNewMessage)==null?void 0:b.call(O,{message:N,messages:t,state:a,agent:e,input:i})}))}return l()}case x.EventType.ACTIVITY_DELTA:{let E=p,g=t.findIndex(y=>y.id===E.messageId);if(g===-1)return console.warn(`ACTIVITY_DELTA: No message found with ID '${E.messageId}' to apply patch`),l();let d=t[g];if(d.role!=="activity")return console.warn(`ACTIVITY_DELTA: Message '${E.messageId}' is not an activity message`),l();let m=d,u=await _(n,t,a,(y,C,N)=>{var O;return(O=y.onActivityDeltaEvent)==null?void 0:O.call(y,{event:E,messages:C,state:N,agent:e,input:i,activityMessage:m})});if(o(u),u.stopPropagation!==!0)try{let y=M((c=m.content)!=null?c:{}),N=(0,ft.applyPatch)(y,(F=E.patch)!=null?F:[],!0,!1).newDocument;t[g]=H(L({},m),{content:M(N),activityType:E.activityType}),o({messages:t})}catch(y){let C=y instanceof Error?y.message:String(y);console.warn(`Failed to apply activity patch for '${E.messageId}': ${C}`)}return l()}case x.EventType.RAW:{let E=await _(n,t,a,(g,d,m)=>{var u;return(u=g.onRawEvent)==null?void 0:u.call(g,{event:p,messages:d,state:m,agent:e,input:i})});return o(E),l()}case x.EventType.CUSTOM:{let E=await _(n,t,a,(g,d,m)=>{var u;return(u=g.onCustomEvent)==null?void 0:u.call(g,{event:p,messages:d,state:m,agent:e,input:i})});return o(E),l()}case x.EventType.RUN_STARTED:{let E=await _(n,t,a,(g,d,m)=>{var u;return(u=g.onRunStartedEvent)==null?void 0:u.call(g,{event:p,messages:d,state:m,agent:e,input:i})});if(o(E),E.stopPropagation!==!0){let g=p;if((z=g.input)!=null&&z.messages){for(let d of g.input.messages)t.find(u=>u.id===d.id)||t.push(d);o({messages:t})}}return l()}case x.EventType.RUN_FINISHED:{let E=await _(n,t,a,(g,d,m)=>{var u;return(u=g.onRunFinishedEvent)==null?void 0:u.call(g,{event:p,messages:d,state:m,agent:e,input:i,result:p.result})});return o(E),l()}case x.EventType.RUN_ERROR:{let E=await _(n,t,a,(g,d,m)=>{var u;return(u=g.onRunErrorEvent)==null?void 0:u.call(g,{event:p,messages:d,state:m,agent:e,input:i})});return o(E),l()}case x.EventType.STEP_STARTED:{let E=await _(n,t,a,(g,d,m)=>{var u;return(u=g.onStepStartedEvent)==null?void 0:u.call(g,{event:p,messages:d,state:m,agent:e,input:i})});return o(E),l()}case x.EventType.STEP_FINISHED:{let E=await _(n,t,a,(g,d,m)=>{var u;return(u=g.onStepFinishedEvent)==null?void 0:u.call(g,{event:p,messages:d,state:m,agent:e,input:i})});return o(E),l()}case x.EventType.TEXT_MESSAGE_CHUNK:throw new Error("TEXT_MESSAGE_CHUNK must be tranformed before being applied");case x.EventType.TOOL_CALL_CHUNK:throw new Error("TOOL_CALL_CHUNK must be tranformed before being applied");case x.EventType.THINKING_START:return l();case x.EventType.THINKING_END:return l();case x.EventType.THINKING_TEXT_MESSAGE_START:return l();case x.EventType.THINKING_TEXT_MESSAGE_CONTENT:return l();case x.EventType.THINKING_TEXT_MESSAGE_END:return l()}let D=p.type;return l()}),(0,K.mergeAll)(),n.length>0?(0,K.defaultIfEmpty)({}):p=>p)};var A=require("@ag-ui/core"),v=require("rxjs"),Rt=require("rxjs/operators"),$=i=>s=>{let e=new Map,n=new Map,t=!1,a=!1,r=!1,o=new Map,l=!1,p=!1,S=!1,D=()=>{e.clear(),n.clear(),o.clear(),l=!1,p=!1,t=!1,a=!1,S=!0};return s.pipe((0,Rt.mergeMap)(T=>{let h=T.type;if(i&&console.debug("[VERIFY]:",JSON.stringify(T)),a)return(0,v.throwError)(()=>new A.AGUIError(`Cannot send event type '${h}': The run has already errored with 'RUN_ERROR'. No further events can be sent.`));if(t&&h!==A.EventType.RUN_ERROR&&h!==A.EventType.RUN_STARTED)return(0,v.throwError)(()=>new A.AGUIError(`Cannot send event type '${h}': The run has already finished with 'RUN_FINISHED'. Start a new run with 'RUN_STARTED'.`));if(r){if(h===A.EventType.RUN_STARTED){if(S&&!t)return(0,v.throwError)(()=>new A.AGUIError("Cannot send 'RUN_STARTED' while a run is still active. The previous run must be finished with 'RUN_FINISHED' before starting a new run."));t&&D()}}else if(r=!0,h!==A.EventType.RUN_STARTED&&h!==A.EventType.RUN_ERROR)return(0,v.throwError)(()=>new A.AGUIError("First event must be 'RUN_STARTED'"));switch(h){case A.EventType.TEXT_MESSAGE_START:{let c=T.messageId;return e.has(c)?(0,v.throwError)(()=>new A.AGUIError(`Cannot send 'TEXT_MESSAGE_START' event: A text message with ID '${c}' is already in progress. Complete it with 'TEXT_MESSAGE_END' first.`)):(e.set(c,!0),(0,v.of)(T))}case A.EventType.TEXT_MESSAGE_CONTENT:{let c=T.messageId;return e.has(c)?(0,v.of)(T):(0,v.throwError)(()=>new A.AGUIError(`Cannot send 'TEXT_MESSAGE_CONTENT' event: No active text message found with ID '${c}'. Start a text message with 'TEXT_MESSAGE_START' first.`))}case A.EventType.TEXT_MESSAGE_END:{let c=T.messageId;return e.has(c)?(e.delete(c),(0,v.of)(T)):(0,v.throwError)(()=>new A.AGUIError(`Cannot send 'TEXT_MESSAGE_END' event: No active text message found with ID '${c}'. A 'TEXT_MESSAGE_START' event must be sent first.`))}case A.EventType.TOOL_CALL_START:{let c=T.toolCallId;return n.has(c)?(0,v.throwError)(()=>new A.AGUIError(`Cannot send 'TOOL_CALL_START' event: A tool call with ID '${c}' is already in progress. Complete it with 'TOOL_CALL_END' first.`)):(n.set(c,!0),(0,v.of)(T))}case A.EventType.TOOL_CALL_ARGS:{let c=T.toolCallId;return n.has(c)?(0,v.of)(T):(0,v.throwError)(()=>new A.AGUIError(`Cannot send 'TOOL_CALL_ARGS' event: No active tool call found with ID '${c}'. Start a tool call with 'TOOL_CALL_START' first.`))}case A.EventType.TOOL_CALL_END:{let c=T.toolCallId;return n.has(c)?(n.delete(c),(0,v.of)(T)):(0,v.throwError)(()=>new A.AGUIError(`Cannot send 'TOOL_CALL_END' event: No active tool call found with ID '${c}'. A 'TOOL_CALL_START' event must be sent first.`))}case A.EventType.STEP_STARTED:{let c=T.stepName;return o.has(c)?(0,v.throwError)(()=>new A.AGUIError(`Step "${c}" is already active for 'STEP_STARTED'`)):(o.set(c,!0),(0,v.of)(T))}case A.EventType.STEP_FINISHED:{let c=T.stepName;return o.has(c)?(o.delete(c),(0,v.of)(T)):(0,v.throwError)(()=>new A.AGUIError(`Cannot send 'STEP_FINISHED' for step "${c}" that was not started`))}case A.EventType.RUN_STARTED:return S=!0,(0,v.of)(T);case A.EventType.RUN_FINISHED:{if(o.size>0){let c=Array.from(o.keys()).join(", ");return(0,v.throwError)(()=>new A.AGUIError(`Cannot send 'RUN_FINISHED' while steps are still active: ${c}`))}if(e.size>0){let c=Array.from(e.keys()).join(", ");return(0,v.throwError)(()=>new A.AGUIError(`Cannot send 'RUN_FINISHED' while text messages are still active: ${c}`))}if(n.size>0){let c=Array.from(n.keys()).join(", ");return(0,v.throwError)(()=>new A.AGUIError(`Cannot send 'RUN_FINISHED' while tool calls are still active: ${c}`))}return t=!0,(0,v.of)(T)}case A.EventType.RUN_ERROR:return a=!0,(0,v.of)(T);case A.EventType.CUSTOM:return(0,v.of)(T);case A.EventType.THINKING_TEXT_MESSAGE_START:return l?p?(0,v.throwError)(()=>new A.AGUIError("Cannot send 'THINKING_TEXT_MESSAGE_START' event: A thinking message is already in progress. Complete it with 'THINKING_TEXT_MESSAGE_END' first.")):(p=!0,(0,v.of)(T)):(0,v.throwError)(()=>new A.AGUIError("Cannot send 'THINKING_TEXT_MESSAGE_START' event: A thinking step is not in progress. Create one with 'THINKING_START' first."));case A.EventType.THINKING_TEXT_MESSAGE_CONTENT:return p?(0,v.of)(T):(0,v.throwError)(()=>new A.AGUIError("Cannot send 'THINKING_TEXT_MESSAGE_CONTENT' event: No active thinking message found. Start a message with 'THINKING_TEXT_MESSAGE_START' first."));case A.EventType.THINKING_TEXT_MESSAGE_END:return p?(p=!1,(0,v.of)(T)):(0,v.throwError)(()=>new A.AGUIError("Cannot send 'THINKING_TEXT_MESSAGE_END' event: No active thinking message found. A 'THINKING_TEXT_MESSAGE_START' event must be sent first."));case A.EventType.THINKING_START:return l?(0,v.throwError)(()=>new A.AGUIError("Cannot send 'THINKING_START' event: A thinking step is already in progress. End it with 'THINKING_END' first.")):(l=!0,(0,v.of)(T));case A.EventType.THINKING_END:return l?(l=!1,(0,v.of)(T)):(0,v.throwError)(()=>new A.AGUIError("Cannot send 'THINKING_END' event: No active thinking step found. A 'THINKING_START' event must be sent first."));default:return(0,v.of)(T)}}))};var Nt=require("@ag-ui/core"),gt=require("rxjs");var k=require("rxjs"),ot=require("rxjs/operators");var rt=(i,s)=>(0,k.defer)(()=>(0,k.from)(fetch(i,s))).pipe((0,ot.switchMap)(e=>{var a;if(!e.ok){let r=e.headers.get("content-type")||"";return(0,k.from)(e.text()).pipe((0,ot.mergeMap)(o=>{let l=o;if(r.includes("application/json"))try{l=JSON.parse(o)}catch(S){}let p=new Error(`HTTP ${e.status}: ${typeof l=="string"?l:JSON.stringify(l)}`);return p.status=e.status,p.payload=l,(0,k.throwError)(()=>p)}))}let n={type:"headers",status:e.status,headers:e.headers},t=(a=e.body)==null?void 0:a.getReader();return t?new k.Observable(r=>(r.next(n),(async()=>{try{for(;;){let{done:o,value:l}=await t.read();if(o)break;let p={type:"data",data:l};r.next(p)}r.complete()}catch(o){r.error(o)}})(),()=>{t.cancel().catch(o=>{if((o==null?void 0:o.name)!=="AbortError")throw o})})):(0,k.throwError)(()=>new Error("Failed to getReader() from response"))}));var xt=require("rxjs");var it=i=>{let s=new xt.Subject,e=new TextDecoder("utf-8",{fatal:!1}),n="";i.subscribe({next:a=>{if(a.type!=="headers"&&a.type==="data"&&a.data){let r=e.decode(a.data,{stream:!0});n+=r;let o=n.split(/\n\n/);n=o.pop()||"";for(let l of o)t(l)}},error:a=>s.error(a),complete:()=>{n&&(n+=e.decode(),t(n)),s.complete()}});function t(a){let r=a.split(`
`),o=[];for(let l of r)l.startsWith("data: ")&&o.push(l.slice(6));if(o.length>0)try{let l=o.join(`
`),p=JSON.parse(l);s.next(p)}catch(l){s.error(l)}}return s.asObservable()};var It=require("rxjs");var _t=st(require("@ag-ui/proto")),lt=i=>{let s=new It.Subject,e=new Uint8Array(0);i.subscribe({next:t=>{if(t.type!=="headers"&&t.type==="data"&&t.data){let a=new Uint8Array(e.length+t.data.length);a.set(e,0),a.set(t.data,e.length),e=a,n()}},error:t=>s.error(t),complete:()=>{if(e.length>0)try{n()}catch(t){console.warn("Incomplete or invalid protocol buffer data at stream end")}s.complete()}});function n(){for(;e.length>=4;){let r=4+new DataView(e.buffer,e.byteOffset,4).getUint32(0,!1);if(e.length<r)break;try{let o=e.slice(4,r),l=_t.decode(o);s.next(l),e=e.slice(r)}catch(o){let l=o instanceof Error?o.message:String(o);s.error(new Error(`Failed to decode protocol buffer message: ${l}`));return}}}return s.asObservable()};var Lt=st(require("@ag-ui/proto")),wt=require("@ag-ui/core"),ct=i=>{let s=new gt.Subject,e=new gt.ReplaySubject,n=!1;return i.subscribe({next:t=>{e.next(t),t.type==="headers"&&!n?(n=!0,t.headers.get("content-type")===Lt.AGUI_MEDIA_TYPE?lt(e).subscribe({next:r=>s.next(r),error:r=>s.error(r),complete:()=>s.complete()}):it(e).subscribe({next:r=>{try{let o=Nt.EventSchemas.parse(r);s.next(o)}catch(o){s.error(o)}},error:r=>{if((r==null?void 0:r.name)==="AbortError"){s.next({type:wt.EventType.RUN_ERROR,rawEvent:r}),s.complete();return}return s.error(r)},complete:()=>s.complete()})):n||s.error(new Error("No headers event received before data events"))},error:t=>{e.error(t),s.error(t)},complete:()=>{e.complete()}}),s.asObservable()};var Ot=require("rxjs/operators"),Pt=require("fast-json-patch"),w=require("@ag-ui/core");var f=require("zod"),I=f.z.enum(["TextMessageStart","TextMessageContent","TextMessageEnd","ActionExecutionStart","ActionExecutionArgs","ActionExecutionEnd","ActionExecutionResult","AgentStateMessage","MetaEvent","RunStarted","RunFinished","RunError","NodeStarted","NodeFinished"]),qt=f.z.enum(["LangGraphInterruptEvent","PredictState","Exit"]),Qt=f.z.object({type:f.z.literal(I.enum.TextMessageStart),messageId:f.z.string(),parentMessageId:f.z.string().optional(),role:f.z.string().optional()}),Zt=f.z.object({type:f.z.literal(I.enum.TextMessageContent),messageId:f.z.string(),content:f.z.string()}),te=f.z.object({type:f.z.literal(I.enum.TextMessageEnd),messageId:f.z.string()}),ee=f.z.object({type:f.z.literal(I.enum.ActionExecutionStart),actionExecutionId:f.z.string(),actionName:f.z.string(),parentMessageId:f.z.string().optional()}),ne=f.z.object({type:f.z.literal(I.enum.ActionExecutionArgs),actionExecutionId:f.z.string(),args:f.z.string()}),se=f.z.object({type:f.z.literal(I.enum.ActionExecutionEnd),actionExecutionId:f.z.string()}),ae=f.z.object({type:f.z.literal(I.enum.ActionExecutionResult),actionName:f.z.string(),actionExecutionId:f.z.string(),result:f.z.string()}),oe=f.z.object({type:f.z.literal(I.enum.AgentStateMessage),threadId:f.z.string(),agentName:f.z.string(),nodeName:f.z.string(),runId:f.z.string(),active:f.z.boolean(),role:f.z.string(),state:f.z.string(),running:f.z.boolean()}),re=f.z.object({type:f.z.literal(I.enum.MetaEvent),name:qt,value:f.z.any()}),ie=f.z.object({type:f.z.literal(I.enum.RunError),message:f.z.string(),code:f.z.string().optional()}),Cn=f.z.discriminatedUnion("type",[Qt,Zt,te,ee,ne,se,ae,oe,re,ie]),Rn=f.z.object({id:f.z.string(),role:f.z.string(),content:f.z.string(),parentMessageId:f.z.string().optional()}),xn=f.z.object({id:f.z.string(),name:f.z.string(),arguments:f.z.any(),parentMessageId:f.z.string().optional()}),In=f.z.object({id:f.z.string(),result:f.z.any(),actionExecutionId:f.z.string(),actionName:f.z.string()});var Dt=st(require("untruncate-json"));var le=i=>{if(typeof i=="string")return i;if(!Array.isArray(i))return;let s=i.filter(e=>e.type==="text").map(e=>e.text).filter(e=>e.length>0);if(s.length!==0)return s.join(`
`)},ut=(i,s,e)=>n=>{let t={},a=!0,r=!0,o="",l=null,p=null,S=[],D={},T=h=>{typeof h=="object"&&h!==null&&("messages"in h&&delete h.messages,t=h)};return n.pipe((0,Ot.mergeMap)(h=>{switch(h.type){case w.EventType.TEXT_MESSAGE_START:{let c=h;return[{type:I.enum.TextMessageStart,messageId:c.messageId,role:c.role}]}case w.EventType.TEXT_MESSAGE_CONTENT:{let c=h;return[{type:I.enum.TextMessageContent,messageId:c.messageId,content:c.delta}]}case w.EventType.TEXT_MESSAGE_END:{let c=h;return[{type:I.enum.TextMessageEnd,messageId:c.messageId}]}case w.EventType.TOOL_CALL_START:{let c=h;return S.push({id:c.toolCallId,type:"function",function:{name:c.toolCallName,arguments:""}}),r=!0,D[c.toolCallId]=c.toolCallName,[{type:I.enum.ActionExecutionStart,actionExecutionId:c.toolCallId,actionName:c.toolCallName,parentMessageId:c.parentMessageId}]}case w.EventType.TOOL_CALL_ARGS:{let c=h,F=S.find(E=>E.id===c.toolCallId);if(!F)return console.warn(`TOOL_CALL_ARGS: No tool call found with ID '${c.toolCallId}'`),[];F.function.arguments+=c.delta;let z=!1;if(p){let E=p.find(g=>g.tool==F.function.name);if(E)try{let g=JSON.parse((0,Dt.default)(F.function.arguments));E.tool_argument&&E.tool_argument in g?(T(H(L({},t),{[E.state_key]:g[E.tool_argument]})),z=!0):E.tool_argument||(T(H(L({},t),{[E.state_key]:g})),z=!0)}catch(g){}}return[{type:I.enum.ActionExecutionArgs,actionExecutionId:c.toolCallId,args:c.delta},...z?[{type:I.enum.AgentStateMessage,threadId:i,agentName:e,nodeName:o,runId:s,running:a,role:"assistant",state:JSON.stringify(t),active:r}]:[]]}case w.EventType.TOOL_CALL_END:{let c=h;return[{type:I.enum.ActionExecutionEnd,actionExecutionId:c.toolCallId}]}case w.EventType.TOOL_CALL_RESULT:{let c=h;return[{type:I.enum.ActionExecutionResult,actionExecutionId:c.toolCallId,result:c.content,actionName:D[c.toolCallId]||"unknown"}]}case w.EventType.RAW:return[];case w.EventType.CUSTOM:{let c=h;switch(c.name){case"Exit":a=!1;break;case"PredictState":p=c.value;break}return[{type:I.enum.MetaEvent,name:c.name,value:c.value}]}case w.EventType.STATE_SNAPSHOT:return T(h.snapshot),[{type:I.enum.AgentStateMessage,threadId:i,agentName:e,nodeName:o,runId:s,running:a,role:"assistant",state:JSON.stringify(t),active:r}];case w.EventType.STATE_DELTA:{let F=(0,Pt.applyPatch)(t,h.delta,!0,!1);return F?(T(F.newDocument),[{type:I.enum.AgentStateMessage,threadId:i,agentName:e,nodeName:o,runId:s,running:a,role:"assistant",state:JSON.stringify(t),active:r}]):[]}case w.EventType.MESSAGES_SNAPSHOT:return l=h.messages,[{type:I.enum.AgentStateMessage,threadId:i,agentName:e,nodeName:o,runId:s,running:a,role:"assistant",state:JSON.stringify(L(L({},t),l?{messages:l}:{})),active:!0}];case w.EventType.RUN_STARTED:return[];case w.EventType.RUN_FINISHED:return l&&(t.messages=l),Object.keys(t).length===0?[]:[{type:I.enum.AgentStateMessage,threadId:i,agentName:e,nodeName:o,runId:s,running:a,role:"assistant",state:JSON.stringify(L(L({},t),l?{messages:ge(l)}:{})),active:!1}];case w.EventType.RUN_ERROR:{let c=h;return[{type:I.enum.RunError,message:c.message,code:c.code}]}case w.EventType.STEP_STARTED:return o=h.stepName,S=[],p=null,[{type:I.enum.AgentStateMessage,threadId:i,agentName:e,nodeName:o,runId:s,running:a,role:"assistant",state:JSON.stringify(t),active:!0}];case w.EventType.STEP_FINISHED:return S=[],p=null,[{type:I.enum.AgentStateMessage,threadId:i,agentName:e,nodeName:o,runId:s,running:a,role:"assistant",state:JSON.stringify(t),active:!1}];default:return[]}}))};function ge(i){var e;let s=[];for(let n of i)if(n.role==="assistant"||n.role==="user"||n.role==="system"){let t=le(n.content);if(t){let a={id:n.id,role:n.role,content:t};s.push(a)}if(n.role==="assistant"&&n.toolCalls&&n.toolCalls.length>0)for(let a of n.toolCalls){let r={id:a.id,name:a.function.name,arguments:JSON.parse(a.function.arguments),parentMessageId:n.id};s.push(r)}}else if(n.role==="tool"){let t="unknown";for(let r of i)if(r.role==="assistant"&&((e=r.toolCalls)!=null&&e.length)){for(let o of r.toolCalls)if(o.id===n.toolCallId){t=o.function.name;break}}let a={id:n.id,result:n.content,actionExecutionId:n.toolCallId,actionName:t};s.push(a)}return s}var W=require("uuid");var bt=require("compare-versions"),X=require("rxjs/operators"),Tt=require("rxjs/operators"),U=require("rxjs");var St=require("rxjs");var Et=require("rxjs"),R=require("@ag-ui/core"),j=i=>s=>{let e,n,t,a=()=>{if(!e||t!=="text")throw new Error("No text message to close");let l={type:R.EventType.TEXT_MESSAGE_END,messageId:e.messageId};return t=void 0,e=void 0,i&&console.debug("[TRANSFORM]: TEXT_MESSAGE_END",JSON.stringify(l)),l},r=()=>{if(!n||t!=="tool")throw new Error("No tool call to close");let l={type:R.EventType.TOOL_CALL_END,toolCallId:n.toolCallId};return t=void 0,n=void 0,i&&console.debug("[TRANSFORM]: TOOL_CALL_END",JSON.stringify(l)),l},o=()=>t==="text"?[a()]:t==="tool"?[r()]:[];return s.pipe((0,Et.mergeMap)(l=>{switch(l.type){case R.EventType.TEXT_MESSAGE_START:case R.EventType.TEXT_MESSAGE_CONTENT:case R.EventType.TEXT_MESSAGE_END:case R.EventType.TOOL_CALL_START:case R.EventType.TOOL_CALL_ARGS:case R.EventType.TOOL_CALL_END:case R.EventType.TOOL_CALL_RESULT:case R.EventType.STATE_SNAPSHOT:case R.EventType.STATE_DELTA:case R.EventType.MESSAGES_SNAPSHOT:case R.EventType.CUSTOM:case R.EventType.RUN_STARTED:case R.EventType.RUN_FINISHED:case R.EventType.RUN_ERROR:case R.EventType.STEP_STARTED:case R.EventType.STEP_FINISHED:case R.EventType.THINKING_START:case R.EventType.THINKING_END:case R.EventType.THINKING_TEXT_MESSAGE_START:case R.EventType.THINKING_TEXT_MESSAGE_CONTENT:case R.EventType.THINKING_TEXT_MESSAGE_END:return[...o(),l];case R.EventType.RAW:case R.EventType.ACTIVITY_SNAPSHOT:case R.EventType.ACTIVITY_DELTA:return[l];case R.EventType.TEXT_MESSAGE_CHUNK:let S=l,D=[];if((t!=="text"||S.messageId!==void 0&&S.messageId!==(e==null?void 0:e.messageId))&&D.push(...o()),t!=="text"){if(S.messageId===void 0)throw new Error("First TEXT_MESSAGE_CHUNK must have a messageId");e={messageId:S.messageId},t="text";let c={type:R.EventType.TEXT_MESSAGE_START,messageId:S.messageId,role:S.role||"assistant"};D.push(c),i&&console.debug("[TRANSFORM]: TEXT_MESSAGE_START",JSON.stringify(c))}if(S.delta!==void 0){let c={type:R.EventType.TEXT_MESSAGE_CONTENT,messageId:e.messageId,delta:S.delta};D.push(c),i&&console.debug("[TRANSFORM]: TEXT_MESSAGE_CONTENT",JSON.stringify(c))}return D;case R.EventType.TOOL_CALL_CHUNK:let T=l,h=[];if((t!=="tool"||T.toolCallId!==void 0&&T.toolCallId!==(n==null?void 0:n.toolCallId))&&h.push(...o()),t!=="tool"){if(T.toolCallId===void 0)throw new Error("First TOOL_CALL_CHUNK must have a toolCallId");if(T.toolCallName===void 0)throw new Error("First TOOL_CALL_CHUNK must have a toolCallName");n={toolCallId:T.toolCallId,toolCallName:T.toolCallName,parentMessageId:T.parentMessageId},t="tool";let c={type:R.EventType.TOOL_CALL_START,toolCallId:T.toolCallId,toolCallName:T.toolCallName,parentMessageId:T.parentMessageId};h.push(c),i&&console.debug("[TRANSFORM]: TOOL_CALL_START",JSON.stringify(c))}if(T.delta!==void 0){let c={type:R.EventType.TOOL_CALL_ARGS,toolCallId:n.toolCallId,delta:T.delta};h.push(c),i&&console.debug("[TRANSFORM]: TOOL_CALL_ARGS",JSON.stringify(c))}return h}let p=l.type;return[]}),(0,Et.finalize)(()=>{o()}))};var At=require("@ag-ui/core");var Ht=require("rxjs"),Gt=require("rxjs/operators");var V=class{runNext(s,e){return e.run(s).pipe(j(!1))}runNextWithState(s,e){let n=M(s.messages||[]),t=M(s.state||{}),a=new Ht.ReplaySubject;return J(s,a,e,[]).subscribe(o=>{o.messages!==void 0&&(n=o.messages),o.state!==void 0&&(t=o.state)}),this.runNext(s,e).pipe((0,Gt.concatMap)(async o=>(a.next(o),await new Promise(l=>setTimeout(l,0)),{event:o,messages:M(n),state:M(t)})))}},Z=class extends V{constructor(e){super();this.fn=e}run(e,n){return this.fn(e,n)}};function ce(i){let s=i.content;if(Array.isArray(s)){let e=s.filter(n=>typeof n=="object"&&n!==null&&"type"in n&&n.type==="text"&&typeof n.text=="string").map(n=>n.text).join("");return H(L({},i),{content:e})}return typeof s=="string"?i:H(L({},i),{content:""})}var tt=class extends V{run(s,e){let r=s,{parentRunId:n}=r,t=yt(r,["parentRunId"]),a=H(L({},t),{messages:t.messages.map(ce)});return this.runNext(a,e)}};var Ft={name:"@ag-ui/client",author:"Markus Ecker <markus.ecker@gmail.com>",version:"0.0.41",private:!1,publishConfig:{access:"public"},main:"./dist/index.js",module:"./dist/index.mjs",types:"./dist/index.d.ts",sideEffects:!1,files:["dist/**","README.md"],scripts:{build:"tsup",dev:"tsup --watch",clean:"rm -rf dist .turbo node_modules",typecheck:"tsc --noEmit",test:"jest","link:global":"pnpm link --global","unlink:global":"pnpm unlink --global"},dependencies:{"@ag-ui/core":"workspace:*","@ag-ui/encoder":"workspace:*","@ag-ui/proto":"workspace:*","@types/uuid":"^10.0.0","compare-versions":"^6.1.1","fast-json-patch":"^3.1.1",rxjs:"7.8.1","untruncate-json":"^0.0.1",uuid:"^11.1.0",zod:"^3.22.4"},devDependencies:{"@types/jest":"^29.5.14","@types/node":"^20.11.19",jest:"^29.7.0","ts-jest":"^29.1.2",tsup:"^8.0.2",typescript:"^5.3.3"}};var Y=class{constructor({agentId:s,description:e,threadId:n,initialMessages:t,initialState:a,debug:r}={}){this.debug=!1;this.subscribers=[];this.isRunning=!1;this.middlewares=[];this.agentId=s,this.description=e!=null?e:"",this.threadId=n!=null?n:(0,W.v4)(),this.messages=M(t!=null?t:[]),this.state=M(a!=null?a:{}),this.debug=r!=null?r:!1,(0,bt.compareVersions)(this.maxVersion,"0.0.39")<=0&&this.middlewares.unshift(new tt)}get maxVersion(){return Ft.version}subscribe(s){return this.subscribers.push(s),{unsubscribe:()=>{this.subscribers=this.subscribers.filter(e=>e!==s)}}}use(...s){let e=s.map(n=>typeof n=="function"?new Z(n):n);return this.middlewares.push(...e),this}async runAgent(s,e){var n;try{this.isRunning=!0,this.agentId=(n=this.agentId)!=null?n:(0,W.v4)();let t=this.prepareRunAgentInput(s),a,r=new Set(this.messages.map(S=>S.id)),o=[{onRunFinishedEvent:S=>{a=S.result}},...this.subscribers,e!=null?e:{}];await this.onInitialize(t,o);let l=(0,U.pipe)(()=>this.middlewares.length===0?this.run(t):this.middlewares.reduceRight((D,T)=>({run:h=>T.run(h,D)}),this).run(t),j(this.debug),$(this.debug),S=>this.apply(t,S,o),S=>this.processApplyEvents(t,S,o),(0,X.catchError)(S=>(this.isRunning=!1,this.onError(t,S,o))),(0,Tt.finalize)(()=>{this.isRunning=!1,this.onFinalize(t,o)}));await(0,St.lastValueFrom)(l((0,U.of)(null)));let p=M(this.messages).filter(S=>!r.has(S.id));return{result:a,newMessages:p}}finally{this.isRunning=!1}}connect(s){throw new At.AGUIConnectNotImplementedError}async connectAgent(s,e){var n;try{this.isRunning=!0,this.agentId=(n=this.agentId)!=null?n:(0,W.v4)();let t=this.prepareRunAgentInput(s),a,r=new Set(this.messages.map(S=>S.id)),o=[{onRunFinishedEvent:S=>{a=S.result}},...this.subscribers,e!=null?e:{}];await this.onInitialize(t,o);let l=(0,U.pipe)(()=>this.connect(t),j(this.debug),$(this.debug),S=>this.apply(t,S,o),S=>this.processApplyEvents(t,S,o),(0,X.catchError)(S=>(this.isRunning=!1,S instanceof At.AGUIConnectNotImplementedError?U.EMPTY:this.onError(t,S,o))),(0,Tt.finalize)(()=>{this.isRunning=!1,this.onFinalize(t,o)}));await(0,St.lastValueFrom)(l((0,U.of)(null)));let p=M(this.messages).filter(S=>!r.has(S.id));return{result:a,newMessages:p}}finally{this.isRunning=!1}}abortRun(){}apply(s,e,n){return J(s,e,this,n)}processApplyEvents(s,e,n){return e.pipe((0,X.tap)(t=>{t.messages&&(this.messages=t.messages,n.forEach(a=>{var r;(r=a.onMessagesChanged)==null||r.call(a,{messages:this.messages,state:this.state,agent:this,input:s})})),t.state&&(this.state=t.state,n.forEach(a=>{var r;(r=a.onStateChanged)==null||r.call(a,{state:this.state,messages:this.messages,agent:this,input:s})}))}))}prepareRunAgentInput(s){var t,a,r;let n=M(this.messages).filter(o=>o.role!=="activity");return{threadId:this.threadId,runId:(s==null?void 0:s.runId)||(0,W.v4)(),tools:M((t=s==null?void 0:s.tools)!=null?t:[]),context:M((a=s==null?void 0:s.context)!=null?a:[]),forwardedProps:M((r=s==null?void 0:s.forwardedProps)!=null?r:{}),state:M(this.state),messages:n}}async onInitialize(s,e){let n=await _(e,this.messages,this.state,(t,a,r)=>{var o;return(o=t.onRunInitialized)==null?void 0:o.call(t,{messages:a,state:r,agent:this,input:s})});(n.messages!==void 0||n.state!==void 0)&&(n.messages&&(this.messages=n.messages,s.messages=n.messages,e.forEach(t=>{var a;(a=t.onMessagesChanged)==null||a.call(t,{messages:this.messages,state:this.state,agent:this,input:s})})),n.state&&(this.state=n.state,s.state=n.state,e.forEach(t=>{var a;(a=t.onStateChanged)==null||a.call(t,{state:this.state,messages:this.messages,agent:this,input:s})})))}onError(s,e,n){return(0,U.from)(_(n,this.messages,this.state,(t,a,r)=>{var o;return(o=t.onRunFailed)==null?void 0:o.call(t,{error:e,messages:a,state:r,agent:this,input:s})})).pipe((0,X.map)(t=>{let a=t;if((a.messages!==void 0||a.state!==void 0)&&(a.messages!==void 0&&(this.messages=a.messages,n.forEach(r=>{var o;(o=r.onMessagesChanged)==null||o.call(r,{messages:this.messages,state:this.state,agent:this,input:s})})),a.state!==void 0&&(this.state=a.state,n.forEach(r=>{var o;(o=r.onStateChanged)==null||o.call(r,{state:this.state,messages:this.messages,agent:this,input:s})}))),a.stopPropagation!==!0)throw console.error("Agent execution failed:",e),e;return{}}))}async onFinalize(s,e){let n=await _(e,this.messages,this.state,(t,a,r)=>{var o;return(o=t.onRunFinalized)==null?void 0:o.call(t,{messages:a,state:r,agent:this,input:s})});(n.messages!==void 0||n.state!==void 0)&&(n.messages!==void 0&&(this.messages=n.messages,e.forEach(t=>{var a;(a=t.onMessagesChanged)==null||a.call(t,{messages:this.messages,state:this.state,agent:this,input:s})})),n.state!==void 0&&(this.state=n.state,e.forEach(t=>{var a;(a=t.onStateChanged)==null||a.call(t,{state:this.state,messages:this.messages,agent:this,input:s})})))}clone(){let s=Object.create(Object.getPrototypeOf(this));return s.agentId=this.agentId,s.description=this.description,s.threadId=this.threadId,s.messages=M(this.messages),s.state=M(this.state),s.debug=this.debug,s.isRunning=this.isRunning,s.subscribers=[...this.subscribers],s}addMessage(s){this.messages.push(s),(async()=>{var e,n,t;for(let a of this.subscribers)await((e=a.onNewMessage)==null?void 0:e.call(a,{message:s,messages:this.messages,state:this.state,agent:this}));if(s.role==="assistant"&&s.toolCalls)for(let a of s.toolCalls)for(let r of this.subscribers)await((n=r.onNewToolCall)==null?void 0:n.call(r,{toolCall:a,messages:this.messages,state:this.state,agent:this}));for(let a of this.subscribers)await((t=a.onMessagesChanged)==null?void 0:t.call(a,{messages:this.messages,state:this.state,agent:this}))})()}addMessages(s){this.messages.push(...s),(async()=>{var e,n,t;for(let a of s){for(let r of this.subscribers)await((e=r.onNewMessage)==null?void 0:e.call(r,{message:a,messages:this.messages,state:this.state,agent:this}));if(a.role==="assistant"&&a.toolCalls)for(let r of a.toolCalls)for(let o of this.subscribers)await((n=o.onNewToolCall)==null?void 0:n.call(o,{toolCall:r,messages:this.messages,state:this.state,agent:this}))}for(let a of this.subscribers)await((t=a.onMessagesChanged)==null?void 0:t.call(a,{messages:this.messages,state:this.state,agent:this}))})()}setMessages(s){this.messages=M(s),(async()=>{var e;for(let n of this.subscribers)await((e=n.onMessagesChanged)==null?void 0:e.call(n,{messages:this.messages,state:this.state,agent:this}))})()}setState(s){this.state=M(s),(async()=>{var e;for(let n of this.subscribers)await((e=n.onStateChanged)==null?void 0:e.call(n,{messages:this.messages,state:this.state,agent:this}))})()}legacy_to_be_removed_runAgentBridged(s){var t;this.agentId=(t=this.agentId)!=null?t:(0,W.v4)();let e=this.prepareRunAgentInput(s);return(this.middlewares.length===0?this.run(e):this.middlewares.reduceRight((r,o)=>({run:l=>o.run(l,r)}),this).run(e)).pipe(j(this.debug),$(this.debug),ut(this.threadId,e.runId,this.agentId),a=>a.pipe((0,X.map)(r=>(this.debug&&console.debug("[LEGACY]:",JSON.stringify(r)),r))))}};var pt=class extends Y{constructor(e){var n;super(e);this.abortController=new AbortController;this.url=e.url,this.headers=M((n=e.headers)!=null?n:{})}requestInit(e){return{method:"POST",headers:H(L({},this.headers),{"Content-Type":"application/json",Accept:"text/event-stream"}),body:JSON.stringify(e),signal:this.abortController.signal}}runAgent(e,n){var t;return this.abortController=(t=e==null?void 0:e.abortController)!=null?t:new AbortController,super.runAgent(e,n)}abortRun(){this.abortController.abort(),super.abortRun()}run(e){let n=rt(this.url,this.requestInit(e));return ct(n)}clone(){var a;let e=super.clone();e.url=this.url,e.headers=M((a=this.headers)!=null?a:{});let n=new AbortController,t=this.abortController.signal;return t.aborted&&n.abort(t.reason),e.abortController=n,e}};var B=require("@ag-ui/core");function Bt(i){let s=[],e=new Map,n=new Map;for(let t of i)if(t.type===B.EventType.TEXT_MESSAGE_START){let a=t,r=a.messageId;e.has(r)||e.set(r,{contents:[],otherEvents:[]});let o=e.get(r);o.start=a}else if(t.type===B.EventType.TEXT_MESSAGE_CONTENT){let a=t,r=a.messageId;e.has(r)||e.set(r,{contents:[],otherEvents:[]}),e.get(r).contents.push(a)}else if(t.type===B.EventType.TEXT_MESSAGE_END){let a=t,r=a.messageId;e.has(r)||e.set(r,{contents:[],otherEvents:[]});let o=e.get(r);o.end=a,kt(r,o,s),e.delete(r)}else if(t.type===B.EventType.TOOL_CALL_START){let a=t,r=a.toolCallId;n.has(r)||n.set(r,{args:[],otherEvents:[]});let o=n.get(r);o.start=a}else if(t.type===B.EventType.TOOL_CALL_ARGS){let a=t,r=a.toolCallId;n.has(r)||n.set(r,{args:[],otherEvents:[]}),n.get(r).args.push(a)}else if(t.type===B.EventType.TOOL_CALL_END){let a=t,r=a.toolCallId;n.has(r)||n.set(r,{args:[],otherEvents:[]});let o=n.get(r);o.end=a,Ut(r,o,s),n.delete(r)}else{let a=!1;for(let[r,o]of e)if(o.start&&!o.end){o.otherEvents.push(t),a=!0;break}if(!a){for(let[r,o]of n)if(o.start&&!o.end){o.otherEvents.push(t),a=!0;break}}a||s.push(t)}for(let[t,a]of e)kt(t,a,s);for(let[t,a]of n)Ut(t,a,s);return s}function kt(i,s,e){if(s.start&&e.push(s.start),s.contents.length>0){let n=s.contents.map(a=>a.delta).join(""),t={type:B.EventType.TEXT_MESSAGE_CONTENT,messageId:i,delta:n};e.push(t)}s.end&&e.push(s.end);for(let n of s.otherEvents)e.push(n)}function Ut(i,s,e){if(s.start&&e.push(s.start),s.args.length>0){let n=s.args.map(a=>a.delta).join(""),t={type:B.EventType.TOOL_CALL_ARGS,toolCallId:i,delta:n};e.push(t)}s.end&&e.push(s.end);for(let n of s.otherEvents)e.push(n)}G(P,require("@ag-ui/core"),module.exports);0&&(module.exports={AbstractAgent,HttpAgent,compactEvents,convertToLegacyEvents,defaultApplyEvents,parseProtoStream,parseSSEStream,randomUUID,runHttpRequest,structuredClone_,transformChunks,transformHttpEventStream,verifyEvents,...require("@ag-ui/core")});
//# sourceMappingURL=index.js.map