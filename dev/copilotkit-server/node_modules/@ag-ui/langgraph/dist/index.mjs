var ht=Object.defineProperty,dt=Object.defineProperties;var gt=Object.getOwnPropertyDescriptors;var J=Object.getOwnPropertySymbols;var Z=Object.prototype.hasOwnProperty,tt=Object.prototype.propertyIsEnumerable;var z=(a,n)=>(n=Symbol[a])?n:Symbol.for("Symbol."+a);var Q=(a,n,t)=>n in a?ht(a,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[n]=t,m=(a,n)=>{for(var t in n||(n={}))Z.call(n,t)&&Q(a,t,n[t]);if(J)for(var t of J(n))tt.call(n,t)&&Q(a,t,n[t]);return a},v=(a,n)=>dt(a,gt(n));var et=(a,n)=>{var t={};for(var e in a)Z.call(a,e)&&n.indexOf(e)<0&&(t[e]=a[e]);if(a!=null&&J)for(var e of J(a))n.indexOf(e)<0&&tt.call(a,e)&&(t[e]=a[e]);return t};var st=(a,n,t)=>(n=a[z("asyncIterator")])?n.call(a):(a=a[z("iterator")](),n={},t=(e,s)=>(s=a[e])&&(n[e]=r=>new Promise((i,c,g)=>(r=s.call(a,r),g=r.done,Promise.resolve(r.value).then(o=>i({value:o,done:g}),c)))),t("next"),t("return"),n);import{HttpAgent as St}from"@ag-ui/client";import{Observable as pt}from"rxjs";import{Client as mt}from"@langchain/langgraph-sdk";import{randomUUID as V}from"crypto";var ct=(u=>(u.OnChainStart="on_chain_start",u.OnChainStream="on_chain_stream",u.OnChainEnd="on_chain_end",u.OnChatModelStart="on_chat_model_start",u.OnChatModelStream="on_chat_model_stream",u.OnChatModelEnd="on_chat_model_end",u.OnToolStart="on_tool_start",u.OnToolEnd="on_tool_end",u.OnCustomEvent="on_custom_event",u.OnInterrupt="on_interrupt",u))(ct||{}),ut=(s=>(s.ManuallyEmitMessage="manually_emit_message",s.ManuallyEmitToolCall="manually_emit_tool_call",s.ManuallyEmitState="manually_emit_state",s.Exit="exit",s))(ut||{});import{AbstractAgent as Et,EventType as h}from"@ag-ui/client";var j=["messages","tools"];function X(a,n){return Object.fromEntries(Object.entries(a).filter(([t])=>n.includes(t)))}function nt({mode:a,state:n,schemaKeys:t}){let e=a==="start"?n:null;return e&&(t!=null&&t.input)&&(e=X(e,[...j,...t.input])),e}function at(a){return a.map(n=>{var t;switch(n.type){case"human":return{id:n.id,role:"user",content:W(w(n.content))};case"ai":let e=w(n.content);return{id:n.id,role:"assistant",content:e?W(e):"",toolCalls:(t=n.tool_calls)==null?void 0:t.map(s=>({id:s.id,type:"function",function:{name:s.name,arguments:JSON.stringify(s.args)}}))};case"system":return{id:n.id,role:"system",content:W(w(n.content))};case"tool":return{id:n.id,role:"tool",content:W(w(n.content)),toolCallId:n.tool_call_id};default:throw new Error("message type returned from LangGraph is not supported.")}})}function $(a){return a.map((n,t)=>{var e,s;switch(n.role){case"user":return{id:n.id,role:n.role,content:n.content,type:"human"};case"assistant":return{id:n.id,type:"ai",role:n.role,content:(e=n.content)!=null?e:"",tool_calls:((s=n.toolCalls)!=null?s:[]).map(r=>({id:r.id,name:r.function.name,args:JSON.parse(r.function.arguments),type:"tool_call"}))};case"system":return{id:n.id,role:n.role,content:n.content,type:"system"};case"tool":return{content:n.content,role:n.role,type:n.role,tool_call_id:n.toolCallId,id:n.id};default:throw console.error(`Message role ${n.role} is not implemented`),new Error("message role is not supported.")}})}function W(a){return typeof a=="string"?a:JSON.stringify(a)}function it(a){var t,e,s,r,i;let n=(t=a.chunk)==null?void 0:t.content;if(n&&Array.isArray(n)&&n.length&&n[0])return n[0].thinking?{text:n[0].thinking,type:"text",index:n[0].index}:null;if((r=(s=(e=a.chunk.additional_kwargs)==null?void 0:e.reasoning)==null?void 0:s.summary)!=null&&r[0]){let c=(i=a.chunk.additional_kwargs)==null?void 0:i.reasoning.summary[0];return!c||!c.text?null:{type:"text",text:c.text,index:c.index}}return null}function w(a){var n;if(!a)return null;if(typeof a=="string")return a;if(Array.isArray(a)&&a.length){let t=(n=a.find(e=>e.type==="text"))==null?void 0:n.text;return t!=null?t:null}return null}var rt=class a extends Et{constructor(t){var e,s;super(t);this.constantSchemaKeys=j;this.config=t,this.messagesInProcess={},this.agentName=t.agentName,this.graphId=t.graphId,this.assistantConfig=t.assistantConfig,this.thinkingProcess=null,this.client=(s=t==null?void 0:t.client)!=null?s:new mt({apiUrl:t.deploymentUrl,apiKey:t.langsmithApiKey,defaultHeaders:m({},(e=t.propertyHeaders)!=null?e:{})})}clone(){return new a(this.config)}dispatchEvent(t){return this.subscriber.next(t),!0}run(t){return new pt(e=>(this.runAgentStream(t,e),()=>{}))}async runAgentStream(t,e){var c,g,o;this.activeRun={id:t.runId,threadId:t.threadId,hasFunctionStreaming:!1},this.subscriber=e,this.assistant||(this.assistant=await this.getAssistant());let s=(c=t.threadId)!=null?c:V(),r=(o=(g=t.forwardedProps)==null?void 0:g.streamMode)!=null?o:["events","values","updates"],i=await this.prepareStream(v(m({},t),{threadId:s}),r);if(!i)return e.error("No stream to regenerate");await this.handleStreamEvents(i,s,e,t,Array.isArray(r)?r:[r])}async prepareRegenerateStream(t,e){var o,u,d;let{threadId:s,messageCheckpoint:r}=t,i=await this.getCheckpointByMessage(r.id,s);if(this.assistant||(this.assistant=await this.getAssistant()),!i)return this.subscriber.error("No checkpoint found for message");let c=await this.client.threads.updateState(s,{values:this.langGraphDefaultMergeState(i.values,[],t),checkpointId:i.checkpoint.checkpoint_id,asNode:(u=(o=i.next)==null?void 0:o[0])!=null?u:"__start__"}),g=v(m({},(d=t.forwardedProps)!=null?d:{}),{input:this.langGraphDefaultMergeState(i.values,[r],t),checkpointId:c.checkpoint.checkpoint_id,streamMode:e});return{streamResponse:this.client.runs.stream(s,this.assistant.assistant_id,g),state:i,streamMode:e}}async prepareStream(t,e){var G,b,D,x,P,F,B,K,S,H;let{threadId:s,state:r,messages:i,tools:c,context:g,forwardedProps:o}=t;this.activeRun.manuallyEmittedState=null;let u=o==null?void 0:o.nodeName,d=s!=null?s:V();this.assistant||(this.assistant=await this.getAssistant());let l=await this.getOrCreateThread(d,o==null?void 0:o.threadMetadata);this.activeRun.threadId=l.thread_id;let E=(G=await this.client.threads.getState(l.thread_id))!=null?G:{values:{}},p=(b=E.values.messages)!=null?b:[],N=$(i),M=this.langGraphDefaultMergeState(v(m({},r),{messages:p}),N,t),I=v(m({},E),{values:v(m({},M),{messages:[...p,...(D=M.messages)!=null?D:[]]})}),A=I.values;if(this.activeRun.schemaKeys=await this.getSchemaKeys(),((x=E.values.messages)!=null?x:[]).length>i.filter(f=>f.role!=="system").length){let f=null;for(let T=i.length-1;T>=0;T--)if(i[T].role==="user"){f=$([i[T]])[0];break}return f?this.prepareRegenerateStream(v(m({},t),{messageCheckpoint:f}),e):this.subscriber.error("No user message found in messages to regenerate")}this.activeRun.graphInfo=await this.client.assistants.getGraph(this.assistant.assistant_id);let R=!((P=o==null?void 0:o.command)!=null&&P.resume)&&d&&this.activeRun.nodeName!="__end__"&&this.activeRun.nodeName?"continue":"start";if(R==="continue"){let f=this.activeRun.graphInfo.edges.find(T=>T.target===this.activeRun.nodeName);await this.client.threads.updateState(d,{values:r,asNode:f==null?void 0:f.source})}let k=nt({mode:R,state:A,schemaKeys:this.activeRun.schemaKeys}),C,O=[this.assistantConfig,o==null?void 0:o.config].filter(Boolean);O.length&&(C=await this.mergeConfigs({configs:O,assistant:this.assistant,schemaKeys:this.activeRun.schemaKeys}));let y=v(m({},o),{streamMode:e,input:k,config:C,context:m(m({},g),(F=C==null?void 0:C.configurable)!=null?F:{})}),_=(S=(K=(B=E.tasks)==null?void 0:B[0])==null?void 0:K.interrupts)!=null?S:[];return _!=null&&_.length&&!((H=o==null?void 0:o.command)!=null&&H.resume)?(this.dispatchEvent({type:h.RUN_STARTED,threadId:d,runId:t.runId}),this.handleNodeChange(u),_.forEach(f=>{this.dispatchEvent({type:h.CUSTOM,name:"on_interrupt",value:typeof f.value=="string"?f.value:JSON.stringify(f.value),rawEvent:f})}),this.dispatchEvent({type:h.RUN_FINISHED,threadId:d,runId:t.runId}),this.subscriber.complete()):{streamResponse:this.client.runs.stream(d,this.assistant.assistant_id,y),state:I}}async handleStreamEvents(t,e,s,r,i){var p,N,M,I,O,y,_,G,b,D;let{forwardedProps:c}=r,g=c==null?void 0:c.nodeName;this.subscriber=s;let o=!1;if(!t)return;let{streamResponse:u,state:d}=t;this.activeRun.prevNodeName=null;let l={},E=d;try{this.dispatchEvent({type:h.RUN_STARTED,threadId:e,runId:this.activeRun.id}),this.handleNodeChange(g);try{for(var A=st(u),R,k,C;R=!(k=await A.next()).done;R=!1){let S=k.value;let H=(p=r.forwardedProps)==null?void 0:p.streamSubgraphs,f=H&&(S.event.startsWith("events")||S.event.startsWith("values"));if(!i.includes(S.event)&&!f&&S.event!=="error")continue;let T=S;if(S.event==="error"){this.dispatchEvent({type:h.RUN_ERROR,message:S.data.message,rawEvent:S});break}if(S.event==="updates")continue;if(S.event==="values"){l=T.data;continue}else if(H&&T.event.startsWith("values|")){l=m(m({},l),T.data);continue}let U=T.data,Y=(N=U.metadata)!=null?N:{},L=Y.langgraph_node,q=U.event;if(this.activeRun.id=Y.run_id,L&&L!==this.activeRun.nodeName&&this.handleNodeChange(L),o=o||q==="on_custom_event"&&U.name==="exit",this.activeRun.exitingNode=this.activeRun.nodeName===L&&q==="on_chain_end",this.activeRun.exitingNode&&(this.activeRun.manuallyEmittedState=null),(M=this.activeRun.graphInfo)!=null&&M.nodes.some(lt=>lt.id===L)&&this.handleNodeChange(L),E.values=(I=this.activeRun.manuallyEmittedState)!=null?I:l,!this.activeRun.nodeName)continue;(JSON.stringify(E)!==JSON.stringify(d)||this.activeRun.prevNodeName!=this.activeRun.nodeName||this.activeRun.exitingNode)&&!this.getMessageInProgress(this.activeRun.id)&&(d=E,this.activeRun.prevNodeName=this.activeRun.nodeName,this.dispatchEvent({type:h.STATE_SNAPSHOT,snapshot:this.getStateSnapshot(d),rawEvent:T})),this.dispatchEvent({type:h.RAW,event:U}),this.handleSingleEvent(U)}}catch(k){C=[k]}finally{try{R&&(k=A.return)&&await k.call(A)}finally{if(C)throw C[0]}}d=await this.client.threads.getState(e);let x=d.tasks,P=(y=(O=x==null?void 0:x[0])==null?void 0:O.interrupts)!=null?y:[],F=d.next.length===0,B=(G=(_=d.metadata)==null?void 0:_.writes)!=null?G:{},K=this.activeRun.nodeName;return P!=null&&P.length||(K=F?"__end__":(b=d.next[0])!=null?b:Object.keys(B)[0]),P.forEach(S=>{this.dispatchEvent({type:h.CUSTOM,name:"on_interrupt",value:typeof S.value=="string"?S.value:JSON.stringify(S.value),rawEvent:S})}),this.handleNodeChange(K),this.handleNodeChange(void 0),this.dispatchEvent({type:h.STATE_SNAPSHOT,snapshot:this.getStateSnapshot(d)}),this.dispatchEvent({type:h.MESSAGES_SNAPSHOT,messages:at((D=d.values.messages)!=null?D:[])}),this.dispatchEvent({type:h.RUN_FINISHED,threadId:e,runId:this.activeRun.id}),this.activeRun=void 0,s.complete()}catch(x){return s.error(x)}}handleSingleEvent(t){var e,s,r,i,c,g,o;switch(t.event){case"on_chat_model_stream":let u=(e=t.metadata["emit-messages"])!=null?e:!0,d=(s=t.metadata["emit-tool-calls"])!=null?s:!0;if(t.data.chunk.response_metadata.finish_reason)return;let l=this.getMessageInProgress(this.activeRun.id),E=!!(l!=null&&l.id),p=(r=t.data.chunk.tool_call_chunks)==null?void 0:r[0],N=(i=t.metadata.predict_state)==null?void 0:i.some(_=>_.tool===(p==null?void 0:p.name)),M=!E&&(p==null?void 0:p.name),I=E&&(l==null?void 0:l.toolCallId)&&(p==null?void 0:p.args),A=E&&(l==null?void 0:l.toolCallId)&&!p;(A||I||M)&&(this.activeRun.hasFunctionStreaming=!0);let R=it(t.data),k=w(t.data.chunk.content),C=!!(!p&&k),O=E&&!(l!=null&&l.toolCallId)&&!C;if(R){this.handleThinkingEvent(R);break}if(!R&&this.thinkingProcess&&(this.dispatchEvent({type:h.THINKING_TEXT_MESSAGE_END}),this.dispatchEvent({type:h.THINKING_END}),this.thinkingProcess=null),N&&this.dispatchEvent({type:h.CUSTOM,name:"PredictState",value:t.metadata.predict_state}),A){this.dispatchEvent({type:h.TOOL_CALL_END,toolCallId:l==null?void 0:l.toolCallId,rawEvent:t})&&(this.messagesInProcess[this.activeRun.id]=null);break}if(O){this.dispatchEvent({type:h.TEXT_MESSAGE_END,messageId:l.id,rawEvent:t})&&(this.messagesInProcess[this.activeRun.id]=null);break}if(M&&d){this.dispatchEvent({type:h.TOOL_CALL_START,toolCallId:p.id,toolCallName:p.name,parentMessageId:t.data.chunk.id,rawEvent:t})&&this.setMessageInProgress(this.activeRun.id,{id:t.data.chunk.id,toolCallId:p.id,toolCallName:p.name});break}if(I&&d){this.dispatchEvent({type:h.TOOL_CALL_ARGS,toolCallId:l==null?void 0:l.toolCallId,delta:p.args,rawEvent:t});break}if(C&&u){l||(this.dispatchEvent({type:h.TEXT_MESSAGE_START,role:"assistant",messageId:t.data.chunk.id,rawEvent:t}),this.setMessageInProgress(this.activeRun.id,{id:t.data.chunk.id,toolCallId:null,toolCallName:null}),l=this.getMessageInProgress(this.activeRun.id)),this.dispatchEvent({type:h.TEXT_MESSAGE_CONTENT,messageId:l.id,delta:k,rawEvent:t});break}break;case"on_chat_model_end":if((c=this.getMessageInProgress(this.activeRun.id))!=null&&c.toolCallId){this.dispatchEvent({type:h.TOOL_CALL_END,toolCallId:this.getMessageInProgress(this.activeRun.id).toolCallId,rawEvent:t})&&(this.messagesInProcess[this.activeRun.id]=null);break}if((g=this.getMessageInProgress(this.activeRun.id))!=null&&g.id){this.dispatchEvent({type:h.TEXT_MESSAGE_END,messageId:this.getMessageInProgress(this.activeRun.id).id,rawEvent:t})&&(this.messagesInProcess[this.activeRun.id]=null);break}break;case"on_custom_event":if(t.name==="manually_emit_message"){this.dispatchEvent({type:h.TEXT_MESSAGE_START,role:"assistant",messageId:t.data.message_id,rawEvent:t}),this.dispatchEvent({type:h.TEXT_MESSAGE_CONTENT,messageId:t.data.message_id,delta:t.data.message,rawEvent:t}),this.dispatchEvent({type:h.TEXT_MESSAGE_END,messageId:t.data.message_id,rawEvent:t});break}if(t.name==="manually_emit_tool_call"){this.dispatchEvent({type:h.TOOL_CALL_START,toolCallId:t.data.id,toolCallName:t.data.name,parentMessageId:t.data.id,rawEvent:t}),this.dispatchEvent({type:h.TOOL_CALL_ARGS,toolCallId:t.data.id,delta:t.data.args,rawEvent:t}),this.dispatchEvent({type:h.TOOL_CALL_END,toolCallId:t.data.id,rawEvent:t});break}t.name==="manually_emit_state"&&(this.activeRun.manuallyEmittedState=t.data,this.dispatchEvent({type:h.STATE_SNAPSHOT,snapshot:this.getStateSnapshot({values:this.activeRun.manuallyEmittedState}),rawEvent:t})),this.dispatchEvent({type:h.CUSTOM,name:t.name,value:t.data,rawEvent:t});break;case"on_tool_end":let y=(o=t.data)==null?void 0:o.output;this.activeRun.hasFunctionStreaming||(this.dispatchEvent({type:h.TOOL_CALL_START,toolCallId:y.tool_call_id,toolCallName:y.name,parentMessageId:y.id,rawEvent:t}),this.dispatchEvent({type:h.TOOL_CALL_ARGS,toolCallId:y.tool_call_id,delta:JSON.stringify(t.data.input),rawEvent:t}),this.dispatchEvent({type:h.TOOL_CALL_END,toolCallId:y.tool_call_id,rawEvent:t})),this.dispatchEvent({type:h.TOOL_CALL_RESULT,toolCallId:y.tool_call_id,content:y==null?void 0:y.content,messageId:V(),role:"tool"});break}}handleThinkingEvent(t){var s;if(!t||!t.type||!t.text)return;let e=t.index;(s=this.thinkingProcess)!=null&&s.index&&this.thinkingProcess.index!==e&&(this.thinkingProcess.type&&this.dispatchEvent({type:h.THINKING_TEXT_MESSAGE_END}),this.dispatchEvent({type:h.THINKING_END}),this.thinkingProcess=null),this.thinkingProcess||(this.dispatchEvent({type:h.THINKING_START}),this.thinkingProcess={index:e}),this.thinkingProcess.type!==t.type&&(this.dispatchEvent({type:h.THINKING_TEXT_MESSAGE_START}),this.thinkingProcess.type=t.type),this.thinkingProcess.type&&this.dispatchEvent({type:h.THINKING_TEXT_MESSAGE_CONTENT,delta:t.text})}getStateSnapshot(t){let e=t.values,s=this.activeRun.schemaKeys;return s!=null&&s.output&&(e=X(e,[...this.constantSchemaKeys,...s.output])),e}async getOrCreateThread(t,e){let s;try{try{s=await this.getThread(t)}catch(r){s=await this.createThread({threadId:t,metadata:e})}}catch(r){throw new Error(`Failed to create thread: ${r.message}`)}return s}async getThread(t){return this.client.threads.get(t)}async createThread(t){return this.client.threads.create(t)}async mergeConfigs({configs:t,assistant:e,schemaKeys:s}){return t.reduce((r,i)=>{var l;let c=r.configurable;i.configurable&&(c=s!=null&&s.config?X(i==null?void 0:i.configurable,[...this.constantSchemaKeys,...(l=s==null?void 0:s.config)!=null?l:[]]):i==null?void 0:i.configurable);let g=v(m(m({},r),i),{configurable:c}),o=r.recursion_limit==null&&i.recursion_limit===25,u=JSON.stringify(g)!==JSON.stringify(r),d=o&&JSON.stringify(v(m({},g),{recursion_limit:null}))===JSON.stringify(v(m({},r),{recursion_limit:null}));return u&&!d?m(m({},r),g):r},e.config)}getMessageInProgress(t){return this.messagesInProcess[t]}setMessageInProgress(t,e){this.messagesInProcess=v(m({},this.messagesInProcess),{[t]:m(m({},this.messagesInProcess[t]),e)})}async getAssistant(){let t=await this.client.assistants.search(),e=t.find(s=>s.graph_id===this.graphId);if(!e)throw console.error(`
      No agent found with graph ID ${this.graphId} found..

      
      These are the available agents: [${t.map(s=>`${s.graph_id} (ID: ${s.assistant_id})`).join(", ")}]
      `),new Error("No agent id found");return e}async getSchemaKeys(){var t,e,s,r;try{let i=await this.client.assistants.getSchemas(this.assistant.assistant_id),c=null,g=[];if("context_schema"in i&&((t=i.context_schema)!=null&&t.properties)&&(g=Object.keys(i.context_schema.properties)),(e=i.config_schema)!=null&&e.properties&&(c=Object.keys(i.config_schema.properties)),!((s=i.input_schema)!=null&&s.properties)||!((r=i.output_schema)!=null&&r.properties))return{config:[],input:null,output:null,context:g};let o=Object.keys(i.input_schema.properties),u=Object.keys(i.output_schema.properties);return{input:o&&o.length?[...o,...this.constantSchemaKeys]:null,output:u&&u.length?[...u,...this.constantSchemaKeys]:null,context:g,config:c}}catch(i){return{config:[],input:this.constantSchemaKeys,output:this.constantSchemaKeys,context:[]}}}langGraphDefaultMergeState(t,e,s){var o,u;e.length>0&&"role"in e[0]&&e[0].role==="system"&&(e=e.slice(1));let r=t.messages||[],i=new Set(r.map(d=>d.id)),c=e.filter(d=>!i.has(d.id)),g=[...(o=t.tools)!=null?o:[],...(u=s.tools)!=null?u:[]].reduce((d,l)=>{let E=l;return l.type||(E={type:"function",name:l.name,function:{name:l.name,description:l.description,parameters:l.parameters}}),d.find(p=>p.name===E.name||p.function.name===E.function.name)?d:[...d,E]},[]);return v(m({},t),{messages:c,tools:g,"ag-ui":{tools:g,context:s.context}})}handleNodeChange(t){var e,s;t==="__end__"&&(t=void 0),t!==((e=this.activeRun)==null?void 0:e.nodeName)&&((s=this.activeRun)!=null&&s.nodeName&&this.endStep(),t&&this.startStep(t)),this.activeRun.nodeName=t}startStep(t){this.dispatchEvent({type:h.STEP_STARTED,stepName:t})}endStep(){this.dispatchEvent({type:h.STEP_FINISHED,stepName:this.activeRun.nodeName})}async getCheckpointByMessage(t,e,s){var M,A;let r=s!=null&&s.checkpoint_id?{checkpoint:{checkpoint_id:s.checkpoint_id}}:void 0,c=[...await this.client.threads.getHistory(e,r)].reverse(),g=c.find(R=>{var k;return(k=R.values.messages)==null?void 0:k.some(C=>C.id===t)});if(!g)throw new Error("Message not found");let o=(M=g.values.messages)!=null?M:[],u=o.findIndex(R=>R.id===t);if(o.slice(u+1).length)return this.getCheckpointByMessage(t,e,g.parent_checkpoint);let l=c.indexOf(g),I=g.values,{messages:E}=I,p=et(I,["messages"]),N=(A=c[l-1])!=null?A:v(m({},g),{values:{}});return v(m({},N),{values:m(m({},N.values),p)})}};var ot=class extends St{};export{ut as CustomEventNames,rt as LangGraphAgent,ct as LangGraphEventTypes,ot as LangGraphHttpAgent};
//# sourceMappingURL=index.mjs.map